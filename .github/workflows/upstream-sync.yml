name: upstream-sync

on:
  workflow_dispatch:
  schedule:
    # Daily at 06:00 UTC.
    - cron: "0 6 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: upstream-sync-main
  cancel-in-progress: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch upstream
        shell: bash
        run: |
          set -euo pipefail
          git remote add upstream https://github.com/openai/codex.git
          git fetch upstream main --no-tags

      - name: Update sync branch
        shell: bash
        run: |
          set -euo pipefail
          base="$(git rev-parse HEAD)"
          upstream="$(git rev-parse upstream/main)"

          if [[ "${base}" == "${upstream}" ]]; then
            echo "Already up to date with upstream/main"
            exit 0
          fi

          git branch -f sync/upstream-main upstream/main
          git push origin sync/upstream-main --force

      - name: Create or reuse pull request
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail

          existing_pr_number="$(
            gh pr list \
              --state open \
              --head sync/upstream-main \
              --base main \
              --json number \
              --jq '.[0].number // empty'
          )"

          if [[ -n "${existing_pr_number}" ]]; then
            echo "PR #${existing_pr_number} already open"
            exit 0
          fi

          gh pr create \
            --head sync/upstream-main \
            --base main \
            --title "Sync upstream/main" \
            --body "Automated sync from upstream/main."
